const n=JSON.parse('{"key":"v-e24c0be2","path":"/java/bussiness-design/%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95.html","title":"一人一单","lang":"zh-CN","frontmatter":{"title":"一人一单","isTimeLine":true,"date":"2024-03-09T00:00:00.000Z","category":["java"],"tag":["system design"],"description":"@Service public class VoucherOrderServiceImpl extends ServiceImpl&lt;VoucherOrderMapper, VoucherOrder&gt; implements IVoucherOrderService { @Resource private ISeckillVoucherService seckillVoucherService; @Resource private RedisIdWorker redisIdWorker; @Resource IVoucherOrderService voucherOrderService; @Override public Result seckillVoucher(Long voucherId) { // 1. 查询优惠券 SeckillVoucher voucher = seckillVoucherService.getById(voucherId); // 2. 判断秒杀是否开发 if(voucher.getBeginTime().isAfter(LocalDateTime.now())) { return Result.fail(\\"秒杀未开始\\"); } // 3. 判断秒杀是否已经结束 if(voucher.getBeginTime().isBefore(LocalDateTime.now())) { return Result.fail(\\"秒杀已结束\\"); } // 4. 判断库存是否充足 if (voucher.getStock() &lt; 1) { return Result.fail(\\"库存不足\\"); } Long userId = UserHolder.getUser().getId(); synchronized (userId.toString().intern()) { return voucherOrderService.createVoucherOrder(voucherId); } } @Transactional public Result createVoucherOrder(Long voucherId) { // 5. 一人一单 Long userId = UserHolder.getUser().getId(); // 5.1 查询订单 int count = query().eq(\\"user_id\\", userId).eq(\\"voucher_id\\", voucherId).count(); // 5.2 判断是否存在 if (count &gt; 0) { return Result.fail(\\"用户已购买\\"); } // 6. 扣减库存 boolean success = seckillVoucherService.update(). setSql(\\"stock = stock - 1\\") .eq(\\"voucher_id\\", voucherId).eq(\\"stock\\", 0) .update(); if (!success) { return Result.fail(\\"库存不足\\"); } // 7. 创建订单 VoucherOrder voucherOrder = new VoucherOrder(); // 7.1 订单id long orderId = redisIdWorker.nextId(\\"order\\"); voucherOrder.setId(orderId); // 7.2 用户id voucherOrder.setUserId(userId); // 7.3 代金券id voucherOrder.setVoucherId(voucherId); save(voucherOrder); // 8 返回订单id return Result.ok(orderId); } }","head":[["meta",{"property":"og:url","content":"https://sparksding.github.io/blogs/java/bussiness-design/%E4%B8%80%E4%BA%BA%E4%B8%80%E5%8D%95.html"}],["meta",{"property":"og:site_name","content":"还不知道叫什么名字"}],["meta",{"property":"og:title","content":"一人一单"}],["meta",{"property":"og:description","content":"@Service public class VoucherOrderServiceImpl extends ServiceImpl&lt;VoucherOrderMapper, VoucherOrder&gt; implements IVoucherOrderService { @Resource private ISeckillVoucherService seckillVoucherService; @Resource private RedisIdWorker redisIdWorker; @Resource IVoucherOrderService voucherOrderService; @Override public Result seckillVoucher(Long voucherId) { // 1. 查询优惠券 SeckillVoucher voucher = seckillVoucherService.getById(voucherId); // 2. 判断秒杀是否开发 if(voucher.getBeginTime().isAfter(LocalDateTime.now())) { return Result.fail(\\"秒杀未开始\\"); } // 3. 判断秒杀是否已经结束 if(voucher.getBeginTime().isBefore(LocalDateTime.now())) { return Result.fail(\\"秒杀已结束\\"); } // 4. 判断库存是否充足 if (voucher.getStock() &lt; 1) { return Result.fail(\\"库存不足\\"); } Long userId = UserHolder.getUser().getId(); synchronized (userId.toString().intern()) { return voucherOrderService.createVoucherOrder(voucherId); } } @Transactional public Result createVoucherOrder(Long voucherId) { // 5. 一人一单 Long userId = UserHolder.getUser().getId(); // 5.1 查询订单 int count = query().eq(\\"user_id\\", userId).eq(\\"voucher_id\\", voucherId).count(); // 5.2 判断是否存在 if (count &gt; 0) { return Result.fail(\\"用户已购买\\"); } // 6. 扣减库存 boolean success = seckillVoucherService.update(). setSql(\\"stock = stock - 1\\") .eq(\\"voucher_id\\", voucherId).eq(\\"stock\\", 0) .update(); if (!success) { return Result.fail(\\"库存不足\\"); } // 7. 创建订单 VoucherOrder voucherOrder = new VoucherOrder(); // 7.1 订单id long orderId = redisIdWorker.nextId(\\"order\\"); voucherOrder.setId(orderId); // 7.2 用户id voucherOrder.setUserId(userId); // 7.3 代金券id voucherOrder.setVoucherId(voucherId); save(voucherOrder); // 8 返回订单id return Result.ok(orderId); } }"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-04-06T01:38:41.000Z"}],["meta",{"property":"article:author","content":"还不知道叫什么名字"}],["meta",{"property":"article:tag","content":"system design"}],["meta",{"property":"article:published_time","content":"2024-03-09T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2024-04-06T01:38:41.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"一人一单\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2024-03-09T00:00:00.000Z\\",\\"dateModified\\":\\"2024-04-06T01:38:41.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"还不知道叫什么名字\\",\\"url\\":\\"https://sparksding.github.io/blogs\\"}]}"]]},"headers":[],"git":{"createdTime":1710214633000,"updatedTime":1712367521000,"contributors":[{"name":"sparksd","email":"sparks23332@163.com","commits":2}]},"readingTime":{"minutes":0.85,"words":255},"filePathRelative":"java/bussiness-design/一人一单.md","localizedDate":"2024年3月9日","excerpt":"<div class=\\"language-java line-numbers-mode\\" data-ext=\\"java\\"><pre class=\\"language-java\\"><code><span class=\\"token annotation punctuation\\">@Service</span>\\n<span class=\\"token keyword\\">public</span> <span class=\\"token keyword\\">class</span> <span class=\\"token class-name\\">VoucherOrderServiceImpl</span> <span class=\\"token keyword\\">extends</span> <span class=\\"token class-name\\">ServiceImpl</span><span class=\\"token generics\\"><span class=\\"token punctuation\\">&lt;</span><span class=\\"token class-name\\">VoucherOrderMapper</span><span class=\\"token punctuation\\">,</span> <span class=\\"token class-name\\">VoucherOrder</span><span class=\\"token punctuation\\">&gt;</span></span> <span class=\\"token keyword\\">implements</span> <span class=\\"token class-name\\">IVoucherOrderService</span> <span class=\\"token punctuation\\">{</span>\\n\\n\\n    <span class=\\"token annotation punctuation\\">@Resource</span>\\n    <span class=\\"token keyword\\">private</span> <span class=\\"token class-name\\">ISeckillVoucherService</span> seckillVoucherService<span class=\\"token punctuation\\">;</span>\\n\\n    <span class=\\"token annotation punctuation\\">@Resource</span>\\n    <span class=\\"token keyword\\">private</span> <span class=\\"token class-name\\">RedisIdWorker</span> redisIdWorker<span class=\\"token punctuation\\">;</span>\\n\\n\\n    <span class=\\"token annotation punctuation\\">@Resource</span>\\n    <span class=\\"token class-name\\">IVoucherOrderService</span> voucherOrderService<span class=\\"token punctuation\\">;</span>\\n\\n\\n    <span class=\\"token annotation punctuation\\">@Override</span>\\n    <span class=\\"token keyword\\">public</span> <span class=\\"token class-name\\">Result</span> <span class=\\"token function\\">seckillVoucher</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">Long</span> voucherId<span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n        <span class=\\"token comment\\">// 1. 查询优惠券</span>\\n        <span class=\\"token class-name\\">SeckillVoucher</span> voucher <span class=\\"token operator\\">=</span> seckillVoucherService<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getById</span><span class=\\"token punctuation\\">(</span>voucherId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n        <span class=\\"token comment\\">// 2. 判断秒杀是否开发</span>\\n        <span class=\\"token keyword\\">if</span><span class=\\"token punctuation\\">(</span>voucher<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getBeginTime</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">isAfter</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">LocalDateTime</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">now</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n            <span class=\\"token keyword\\">return</span> <span class=\\"token class-name\\">Result</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">fail</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"秒杀未开始\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token punctuation\\">}</span>\\n\\n        <span class=\\"token comment\\">// 3. 判断秒杀是否已经结束</span>\\n        <span class=\\"token keyword\\">if</span><span class=\\"token punctuation\\">(</span>voucher<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getBeginTime</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">isBefore</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">LocalDateTime</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">now</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n            <span class=\\"token keyword\\">return</span> <span class=\\"token class-name\\">Result</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">fail</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"秒杀已结束\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token punctuation\\">}</span>\\n\\n        <span class=\\"token comment\\">// 4. 判断库存是否充足</span>\\n        <span class=\\"token keyword\\">if</span> <span class=\\"token punctuation\\">(</span>voucher<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getStock</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span> <span class=\\"token operator\\">&lt;</span> <span class=\\"token number\\">1</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n            <span class=\\"token keyword\\">return</span> <span class=\\"token class-name\\">Result</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">fail</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"库存不足\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token punctuation\\">}</span>\\n\\n        <span class=\\"token class-name\\">Long</span> userId <span class=\\"token operator\\">=</span> <span class=\\"token class-name\\">UserHolder</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getUser</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getId</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n        <span class=\\"token keyword\\">synchronized</span> <span class=\\"token punctuation\\">(</span>userId<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">toString</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">intern</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n            <span class=\\"token keyword\\">return</span> voucherOrderService<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">createVoucherOrder</span><span class=\\"token punctuation\\">(</span>voucherId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token punctuation\\">}</span>\\n    <span class=\\"token punctuation\\">}</span>\\n\\n    <span class=\\"token annotation punctuation\\">@Transactional</span>\\n    <span class=\\"token keyword\\">public</span> <span class=\\"token class-name\\">Result</span> <span class=\\"token function\\">createVoucherOrder</span><span class=\\"token punctuation\\">(</span><span class=\\"token class-name\\">Long</span> voucherId<span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n        <span class=\\"token comment\\">// 5. 一人一单</span>\\n        <span class=\\"token class-name\\">Long</span> userId <span class=\\"token operator\\">=</span> <span class=\\"token class-name\\">UserHolder</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getUser</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">getId</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n        <span class=\\"token comment\\">// 5.1 查询订单</span>\\n        <span class=\\"token keyword\\">int</span> count <span class=\\"token operator\\">=</span> <span class=\\"token function\\">query</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">eq</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"user_id\\"</span><span class=\\"token punctuation\\">,</span> userId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">eq</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"voucher_id\\"</span><span class=\\"token punctuation\\">,</span> voucherId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">count</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n        <span class=\\"token comment\\">// 5.2 判断是否存在</span>\\n        <span class=\\"token keyword\\">if</span> <span class=\\"token punctuation\\">(</span>count <span class=\\"token operator\\">&gt;</span> <span class=\\"token number\\">0</span><span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n            <span class=\\"token keyword\\">return</span> <span class=\\"token class-name\\">Result</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">fail</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"用户已购买\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token punctuation\\">}</span>\\n\\n        <span class=\\"token comment\\">// 6. 扣减库存</span>\\n        <span class=\\"token keyword\\">boolean</span> success <span class=\\"token operator\\">=</span> seckillVoucherService<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">update</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span>\\n                <span class=\\"token function\\">setSql</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"stock = stock - 1\\"</span><span class=\\"token punctuation\\">)</span>\\n                <span class=\\"token punctuation\\">.</span><span class=\\"token function\\">eq</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"voucher_id\\"</span><span class=\\"token punctuation\\">,</span> voucherId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">eq</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"stock\\"</span><span class=\\"token punctuation\\">,</span> <span class=\\"token number\\">0</span><span class=\\"token punctuation\\">)</span>\\n                <span class=\\"token punctuation\\">.</span><span class=\\"token function\\">update</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n        <span class=\\"token keyword\\">if</span> <span class=\\"token punctuation\\">(</span><span class=\\"token operator\\">!</span>success<span class=\\"token punctuation\\">)</span> <span class=\\"token punctuation\\">{</span>\\n            <span class=\\"token keyword\\">return</span> <span class=\\"token class-name\\">Result</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">fail</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"库存不足\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token punctuation\\">}</span>\\n\\n        <span class=\\"token comment\\">// 7. 创建订单</span>\\n        <span class=\\"token class-name\\">VoucherOrder</span> voucherOrder <span class=\\"token operator\\">=</span> <span class=\\"token keyword\\">new</span> <span class=\\"token class-name\\">VoucherOrder</span><span class=\\"token punctuation\\">(</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token comment\\">// 7.1 订单id</span>\\n        <span class=\\"token keyword\\">long</span> orderId <span class=\\"token operator\\">=</span> redisIdWorker<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">nextId</span><span class=\\"token punctuation\\">(</span><span class=\\"token string\\">\\"order\\"</span><span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        voucherOrder<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">setId</span><span class=\\"token punctuation\\">(</span>orderId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n        <span class=\\"token comment\\">// 7.2 用户id</span>\\n        voucherOrder<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">setUserId</span><span class=\\"token punctuation\\">(</span>userId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token comment\\">// 7.3 代金券id</span>\\n        voucherOrder<span class=\\"token punctuation\\">.</span><span class=\\"token function\\">setVoucherId</span><span class=\\"token punctuation\\">(</span>voucherId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n        <span class=\\"token function\\">save</span><span class=\\"token punctuation\\">(</span>voucherOrder<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n\\n        <span class=\\"token comment\\">// 8 返回订单id</span>\\n        <span class=\\"token keyword\\">return</span> <span class=\\"token class-name\\">Result</span><span class=\\"token punctuation\\">.</span><span class=\\"token function\\">ok</span><span class=\\"token punctuation\\">(</span>orderId<span class=\\"token punctuation\\">)</span><span class=\\"token punctuation\\">;</span>\\n    <span class=\\"token punctuation\\">}</span>\\n<span class=\\"token punctuation\\">}</span>\\n</code></pre><div class=\\"line-numbers\\" aria-hidden=\\"true\\"><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div><div class=\\"line-number\\"></div></div></div>","autoDesc":true}');export{n as data};
