import{_ as e}from"./plugin-vue_export-helper-c27b6911.js";import{r as a,o as t,c as i,d as n,e as r,b as l,f as p}from"./app-a0ad7bcf.js";const c={},u=p(`<h2 id="leader-election问题记录" tabindex="-1"><a class="header-anchor" href="#leader-election问题记录" aria-hidden="true">#</a> Leader Election问题记录</h2><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>                                                                                                                                                                   S3 NO PROBLEM                                        
                                                                                                             S2 term 0 isLeader false state FOLLOWER                                                                    
                                                       S1 term 0 isLeader false state FOLLOWER                                                                                                                          
S0 term 0 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                       S1 term 0 from FOLLOWER to CANDIDATE                                                                                                                             
                                                       S1 term 0 isLeader false state CANDIDATE                                                                                                                         
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
                                                       S1 term 1 from CANDIDATE to LEADER voteCount 2                                                                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
S0 Receive Heartbeat MyTerm 1 HTerm 1                                                                                                                                                                                   
                                                                                                             S2 Receive Heartbeat MyTerm 1 HTerm 1                                                                      
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 Receive Heartbeat MyTerm 1 HTerm 1                                                                                                                                                                                   
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                                                                             S2 Receive Heartbeat MyTerm 1 HTerm 1                                                                      
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 Receive Heartbeat MyTerm 1 HTerm 1                                                                      
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
S0 Receive Heartbeat MyTerm 1 HTerm 1                                                                                                                                                                                   
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 Receive Heartbeat MyTerm 1 HTerm 1                                                                                                                                                                                   
                                                                                                             S2 Receive Heartbeat MyTerm 1 HTerm 1                                                                      
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
                                                                                                                                                                   S3 DISCONNECT 1                                      
                                                                                                                                                                   S3 CONFIDENT                                         
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 1 from FOLLOWER to CANDIDATE                                                                                                                                                                                    
S0 term 1 isLeader false state CANDIDATE                                                                                                                                                                                
                                                                                                             S2 term 1 from FOLLOWER to CANDIDATE                                                                       
                                                                                                             S2 term 1 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 3 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 3 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 3 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 3 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 3 isLeader false state CANDIDATE                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER          
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目前的问题是：S1被disconnect之后，S0和S2没有办法选举出leader，从LOG看他们都在发RequestVote</p><p>目前投票的核心代码如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">RequestVote</span><span class="token punctuation">(</span>args <span class="token operator">*</span>RequestVoteArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>RequestVoteReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// Your code here (2A, 2B).</span>
  rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 1. 如果任期比自己的任期小，返回自己的任期</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&lt;=</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>VoteGranted <span class="token operator">=</span> <span class="token boolean">false</span>
		reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>currentTerm
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// 2. 设置自身为FOLLOWER</span>
	<span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> FOLLOWER <span class="token punctuation">{</span>
		<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d term %d from %v to %v&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>FOLLOWER<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	rf<span class="token punctuation">.</span>state <span class="token operator">=</span> FOLLOWER

	<span class="token comment">// 3. 设置任期为args中的任期</span>
	rf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> args<span class="token punctuation">.</span>Term

	<span class="token comment">// 4. 投票</span>
	reply<span class="token punctuation">.</span>VoteGranted <span class="token operator">=</span> <span class="token boolean">true</span>
	reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> args<span class="token punctuation">.</span>Term

	<span class="token comment">// 5. 清理timer</span>
	rf<span class="token punctuation">.</span>chanGrantVote <span class="token operator">&lt;-</span> <span class="token boolean">true</span>

	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">sendRequestVote</span><span class="token punctuation">(</span>server <span class="token builtin">int</span><span class="token punctuation">,</span> args <span class="token operator">*</span>RequestVoteArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>RequestVoteReply<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Debug(dVote, &quot;S%d term %d, SendRequestVote to %v&quot;, rf.me, rf.currentTerm, server)</span>
	ok <span class="token operator">:=</span> rf<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;Raft.RequestVote&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">)</span>

	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// 1. 处理投票</span>
		<span class="token keyword">if</span> reply<span class="token punctuation">.</span>VoteGranted <span class="token operator">==</span> <span class="token boolean">true</span> <span class="token punctuation">{</span>
			rf<span class="token punctuation">.</span>voteCount<span class="token operator">++</span>
			<span class="token comment">// 2.2. 有超过半数的票</span>
			<span class="token keyword">if</span> rf<span class="token punctuation">.</span>voteCount <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>peers<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> LEADER <span class="token punctuation">{</span>
					<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d term %d from %v to %v voteCount %d&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>LEADER<span class="token punctuation">)</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>voteCount<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				rf<span class="token punctuation">.</span>state <span class="token operator">=</span> LEADER
				rf<span class="token punctuation">.</span>chanWinElect <span class="token operator">&lt;-</span> <span class="token boolean">true</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> rf<span class="token punctuation">.</span>currentTerm <span class="token operator">&lt;</span> reply<span class="token punctuation">.</span>Term <span class="token punctuation">{</span>
				rf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> reply<span class="token punctuation">.</span>Term
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> ok
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>心跳的核心代码如下：</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">InstallSnapshot</span><span class="token punctuation">(</span>args <span class="token operator">*</span>InstallSnapshotArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>InstallSnapshotReply<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d Receive Heartbeat MyTerm %d HTerm %d&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> args<span class="token punctuation">.</span>Term<span class="token punctuation">)</span>

	<span class="token comment">// 1. 如果任期比自己的任期小，返回自己的任期</span>
	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&lt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
		reply<span class="token punctuation">.</span>Term <span class="token operator">=</span> rf<span class="token punctuation">.</span>currentTerm
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> args<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token operator">&amp;&amp;</span> rf<span class="token punctuation">.</span>state <span class="token operator">==</span> LEADER <span class="token punctuation">{</span>
		<span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> FOLLOWER <span class="token punctuation">{</span>
			<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d term %d from %v to %v&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>FOLLOWER<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		rf<span class="token punctuation">.</span>state <span class="token operator">=</span> FOLLOWER
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	rf<span class="token punctuation">.</span>currentTerm <span class="token operator">=</span> args<span class="token punctuation">.</span>Term

	<span class="token comment">// 2. heartbeat</span>
	rf<span class="token punctuation">.</span>chanHeartbeat <span class="token operator">&lt;-</span> <span class="token boolean">true</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">sendInstallSnapshot</span><span class="token punctuation">(</span>server <span class="token builtin">int</span><span class="token punctuation">,</span> args <span class="token operator">*</span>InstallSnapshotArgs<span class="token punctuation">,</span> reply <span class="token operator">*</span>InstallSnapshotReply<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token comment">// Debug(dLeader, &quot;S%d term %d, SendHeartbeat to %v&quot;, rf.me, rf.currentTerm, server)</span>
	ok <span class="token operator">:=</span> rf<span class="token punctuation">.</span>peers<span class="token punctuation">[</span>server<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token string">&quot;Raft.InstallSnapshot&quot;</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> reply<span class="token punctuation">)</span>
	rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		<span class="token comment">// 1. 任期比自己大</span>
		<span class="token keyword">if</span> reply<span class="token punctuation">.</span>Term <span class="token operator">&gt;</span> rf<span class="token punctuation">.</span>currentTerm <span class="token punctuation">{</span>
			<span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> FOLLOWER <span class="token punctuation">{</span>
				<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d term %d from %v to %v&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>FOLLOWER<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			rf<span class="token punctuation">.</span>state <span class="token operator">=</span> FOLLOWER
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> ok
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>主逻辑如下</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rf <span class="token operator">*</span>Raft<span class="token punctuation">)</span> <span class="token function">ticker</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> rf<span class="token punctuation">.</span><span class="token function">killed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token punctuation">{</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> isLeader <span class="token operator">:=</span> rf<span class="token punctuation">.</span><span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d term %d isLeader %v state %v&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> isLeader<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// Your code here (2A)</span>
		<span class="token comment">// Check if a leader election should be started.</span>
		<span class="token keyword">switch</span> rf<span class="token punctuation">.</span>state <span class="token punctuation">{</span>
		<span class="token keyword">case</span> FOLLOWER<span class="token punctuation">:</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>rf<span class="token punctuation">.</span>chanGrantVote<span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>rf<span class="token punctuation">.</span>chanHeartbeat<span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
				rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> CANDIDATE <span class="token punctuation">{</span>
					<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d term %d from %v to %v&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>CANDIDATE<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				rf<span class="token punctuation">.</span>state <span class="token operator">=</span> CANDIDATE
				rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

		<span class="token keyword">case</span> CANDIDATE<span class="token punctuation">:</span>
			<span class="token keyword">go</span> rf<span class="token punctuation">.</span><span class="token function">broadcastRequestVote</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">select</span> <span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>rf<span class="token punctuation">.</span>chanWinElect<span class="token punctuation">:</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>rf<span class="token punctuation">.</span>chanHeartbeat<span class="token punctuation">:</span>
				rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> FOLLOWER <span class="token punctuation">{</span>
					<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d term %d from %v to %v&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>FOLLOWER<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				rf<span class="token punctuation">.</span>state <span class="token operator">=</span> FOLLOWER
				rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>rf<span class="token punctuation">.</span>chanGrantVote<span class="token punctuation">:</span>
				rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> rf<span class="token punctuation">.</span>state <span class="token operator">!=</span> FOLLOWER <span class="token punctuation">{</span>
					<span class="token function">Debug</span><span class="token punctuation">(</span>dVote<span class="token punctuation">,</span> <span class="token string">&quot;S%d term %d from %v to %v&quot;</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span>me<span class="token punctuation">,</span> rf<span class="token punctuation">.</span>currentTerm<span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>rf<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span> rf<span class="token punctuation">.</span><span class="token function">enumToString</span><span class="token punctuation">(</span>FOLLOWER<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				rf<span class="token punctuation">.</span>state <span class="token operator">=</span> FOLLOWER
				rf<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> time<span class="token punctuation">.</span><span class="token function">Duration</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">Intn</span><span class="token punctuation">(</span><span class="token number">300</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
			<span class="token punctuation">}</span>

		<span class="token keyword">case</span> LEADER<span class="token punctuation">:</span>
			<span class="token keyword">go</span> rf<span class="token punctuation">.</span><span class="token function">broadcastHeartbeat</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Millisecond <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>经过一段时间的debug，发现是出现了死锁，从Log中可以看到一直在before enter lock</p><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>S0 term 0 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                                                                                                                                   S3 NO PROBLEM                                        
                                                                                                             S2 term 0 isLeader false state FOLLOWER                                                                    
                                                       S1 term 0 isLeader false state FOLLOWER                                                                                                                          
                                                       S1 term 0 from FOLLOWER to CANDIDATE                                                                                                                             
                                                       S1 term 0 isLeader false state CANDIDATE                                                                                                                         
                                                       S1 term 0, Before Enter Lock                                                                                                                                     
                                                       S1 term 1, broadcastRequestVote                                                                                                                                  
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
                                                       S1 term 1 from CANDIDATE to LEADER voteCount 2                                                                                                                   
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                                                                             S2 Receive Heartbeat MyTerm 1 HTerm 1                                                                      
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
S0 Receive Heartbeat MyTerm 1 HTerm 1                                                                                                                                                                                   
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 Receive Heartbeat MyTerm 1 HTerm 1                                                                      
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
S0 Receive Heartbeat MyTerm 1 HTerm 1                                                                                                                                                                                   
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 Receive Heartbeat MyTerm 1 HTerm 1                                                                      
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
S0 Receive Heartbeat MyTerm 1 HTerm 1                                                                                                                                                                                   
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 Receive Heartbeat MyTerm 1 HTerm 1                                                                      
                                                                                                             S2 term 1 isLeader false state FOLLOWER                                                                    
S0 Receive Heartbeat MyTerm 1 HTerm 1                                                                                                                                                                                   
S0 term 1 isLeader false state FOLLOWER                                                                                                                                                                                 
                                                                                                                                                                   S3 DISCONNECT 1                                      
                                                                                                                                                                   S3 CONFIDENT                                         
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 1 from FOLLOWER to CANDIDATE                                                                       
                                                                                                             S2 term 1 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 1, Before Enter Lock                                                                               
                                                                                                             S2 term 2, broadcastRequestVote                                                                            
S0 term 1 from FOLLOWER to CANDIDATE                                                                                                                                                                                    
S0 term 1 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 1, Before Enter Lock                                                                                                                                                                                            
S0 term 2, broadcastRequestVote                                                                                                                                                                                         
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
S0 term 2 isLeader false state CANDIDATE                                                                                                                                                                                
S0 term 2, Before Enter Lock                                                                                                                                                                                            
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                                                                             S2 term 2 isLeader false state CANDIDATE                                                                   
                                                                                                             S2 term 2, Before Enter Lock                                                                               
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER                                                                                                                             
                                                       S1 term 1 isLeader true state LEADER
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>问题出在sendInstallSnapshot和sendRequestVote，应该在发RPC请求之后加锁。<br> 如果在发RPC请求之前加锁，那么会出现S0向S1发了RPC请求，SO自身mu加锁了，此时S1再给S0发RPC请求，S1自身mu加锁，那么在S0和S1分别处理对方的RPC请求时就会发生死锁。</p><h2 id="参考文章" tabindex="-1"><a class="header-anchor" href="#参考文章" aria-hidden="true">#</a> 参考文章</h2>`,13),o={href:"https://blog.josejg.com/debugging-pretty/",target:"_blank",rel:"noopener noreferrer"};function d(v,m){const s=a("ExternalLinkIcon");return t(),i("div",null,[u,n("p",null,[n("a",o,[r("如何debug"),l(s)])])])}const b=e(c,[["render",d],["__file","raft实验.html.vue"]]);export{b as default};
